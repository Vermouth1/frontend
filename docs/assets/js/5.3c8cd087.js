(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{361:function(e,t,v){e.exports=v.p+"assets/img/queue.e2582e98.png"},362:function(e,t,v){e.exports=v.p+"assets/img/dynamic.3cc95247.png"},363:function(e,t){e.exports="data:image/png;base64,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"},410:function(e,t,v){"use strict";v.r(t);var s=v(26),a=Object(s.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"消息队列-事件循环"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#消息队列-事件循环"}},[e._v("#")]),e._v(" 消息队列&事件循环")]),e._v(" "),s("p",[e._v("每个渲染进程都有一个主线程，既要处理 DOM，又要计算样式，还要处理布局，同时还需要处理 JavaScript 任务以及各种输入事件。为了协调事件，用户交互，脚本，渲染，网络任务等，浏览器用到了消息队列和事件循环系统")]),e._v(" "),s("p",[s("img",{attrs:{src:v(361),alt:"消息队列&事件循环"}})]),e._v(" "),s("p",[e._v("其中渲染进程专门有一个 IO 线程用来接收其他进程传进来的消息，接收到消息之后，会将这些消息组装成任务发送给渲染主线程")]),e._v(" "),s("p",[e._v("消息队列中的任务类型包括了输入事件（鼠标滚动、点击、移动）、微任务、文件读写、WebSocket、JavaScript 定时器等等，除此之外，消息队列中还包含了很多与页面相关的事件，如 JavaScript 执行、解析 DOM、样式计算、布局计算、CSS 动画等。")]),e._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[e._v("注意")]),e._v(" "),s("p",[s("strong",[e._v("事件循环中可能会有一个或多个任务队列，浏览器会在保持任务顺序的前提下，可能分配四分之三的优先权给鼠标和键盘事件，保证用户的输入得到最高优先级的响应，这就用到了动态调度策略")])])]),e._v(" "),s("h2",{attrs:{id:"动态调度"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#动态调度"}},[e._v("#")]),e._v(" 动态调度")]),e._v(" "),s("p",[s("img",{attrs:{src:v(362),alt:"动态调度策略"}})]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("页面加载阶段")]),e._v("，在这个阶段，用户的最高诉求是在尽可能短的时间内看到页面，至于交互和合成并不是这个阶段的核心诉求，因此我们需要调整策略，在加载阶段将页面解析，JavaScript 脚本执行等任务调整为优先级最高的队列，降低交互合成这些队列的优先级。")]),e._v(" "),s("li",[s("strong",[e._v("交互阶段")]),e._v("，当在执行用户交互的任务时，将合成任务的优先级调整到最高")]),e._v(" "),s("li",[s("strong",[e._v("防止任务饿死")]),e._v("，在某个状态下，一直有新的高优先级的任务加入到队列中，这样就会导致其他低优先级的任务得不到执行，这称为任务饿死。Chromium 为了解决任务饿死的问题，给每个队列设置了执行权重，也就是如果连续执行了一定个数的高优先级的任务，那么中间会执行一次低优先级的任务，这样就缓解了任务饿死的情况。")])]),e._v(" "),s("h2",{attrs:{id:"settimeout实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#settimeout实现"}},[e._v("#")]),e._v(" setTimeout实现")]),e._v(" "),s("p",[e._v("当通过 JavaScript 创建一个定时器时，渲染进程会将该定时器的回调任务添加到延迟队列("),s("strong",[e._v("其实是一个 hashmap 结构")]),e._v(")中。处理完消息队列中的一个任务后，开始执行 "),s("strong",[e._v("ProcessDelayTask")]),e._v(" 函数，ProcessDelayTask 函数会根据发起时间和延迟时间计算出到期的任务，然后依次执行这些到期的任务。等到期的任务执行完成之后，再继续下一个循环过程。")]),e._v(" "),s("p",[e._v("注意事项：")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("如果当前任务执行时间过久，会影响定时器任务的执行")])]),e._v(" "),s("li",[s("strong",[e._v("如果 setTimeout 存在嵌套调用，那么系统会设置最短时间间隔为 4 毫秒")])]),e._v(" "),s("li",[s("strong",[e._v("未激活的页面，setTimeout 执行最小间隔是 1000 毫秒")])]),e._v(" "),s("li",[s("strong",[e._v("延时执行时间有最大值，如果超过了 2147483647 ms，那么相当于延时值被设置为 0 了")])])]),e._v(" "),s("h2",{attrs:{id:"微任务队列"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#微任务队列"}},[e._v("#")]),e._v(" 微任务队列")]),e._v(" "),s("p",[e._v("当 JavaScript 执行一段脚本的时候，V8 会为其创建一个全局执行上下文，在创建全局执行上下文的同时，V8 引擎也会在内部创建一个微任务队列，例如 MutationObserver 和 Promise 回调会加在微任务队列中")]),e._v(" "),s("ul",[s("li",[e._v("微任务和宏任务是绑定的，每个宏任务在执行时，会创建自己的微任务队列。")]),e._v(" "),s("li",[e._v("微任务的执行时长会影响到当前宏任务的时长。")]),e._v(" "),s("li",[e._v("在一个宏任务中，分别创建一个用于回调的宏任务和微任务，无论什么情况下，微任务都早于宏任务执行。")]),e._v(" "),s("li",[e._v("如果在执行微任务的过程中，产生了新的微任务，同样会将该微任务添加到微任务队列中，V8 引擎一直循环执行微任务队列中的任务，直到队列为空才算执行结束。")])]),e._v(" "),s("h2",{attrs:{id:"requestanimationframe"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#requestanimationframe"}},[e._v("#")]),e._v(" requestAnimationFrame")]),e._v(" "),s("p",[e._v("是一个特别的异步任务，不加入普通消息队列，回调是在下次渲染之前执行。常用来做动画")]),e._v(" "),s("ul",[s("li",[e._v("果任务本身又新增 Animation callback 就不会当场执行了，因为那是下一个循环")]),e._v(" "),s("li",[e._v("回调也会产生阻塞")])]),e._v(" "),s("h2",{attrs:{id:"对比-node-下的-event-loop"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#对比-node-下的-event-loop"}},[e._v("#")]),e._v(" 对比 Node 下的 Event Loop")]),e._v(" "),s("p",[e._v("Node下的事件循环分为6个阶段，每当进入某一个阶段的时候，都会从对应的回调队列中取出函数去执行。当队列为空或者执行的回调函数数量到达系统设定的阈值，就会进入下一阶段。")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("timers 阶段")]),e._v("：这个阶段执行timer（setTimeout、setInterval）的回调")]),e._v(" "),s("li",[s("strong",[e._v("I/O callbacks 阶段")]),e._v("：处理一些上一轮循环中的少数未执行的 I/O 回调")]),e._v(" "),s("li",[s("strong",[e._v("idle, prepare 阶段")]),e._v("：仅node内部使用")]),e._v(" "),s("li",[s("strong",[e._v("poll 阶段")]),e._v("：获取新的I/O事件, 适当的条件下node将阻塞在这里")]),e._v(" "),s("li",[s("strong",[e._v("check 阶段")]),e._v("：执行 setImmediate() 的回调")]),e._v(" "),s("li",[s("strong",[e._v("close callbacks 阶段")]),e._v("：执行 socket 的 close 事件回调")])]),e._v(" "),s("p",[e._v("外部输入数据--\x3e轮询阶段(poll)--\x3e检查阶段(check)--\x3e关闭事件回调阶段(close callback)--\x3e定时器检测阶段(timer)--\x3eI/O事件回调阶段(I/O callbacks)--\x3e闲置阶段(idle, prepare)--\x3e轮询阶段（按照该顺序反复运行）")]),e._v(" "),s("p",[s("img",{attrs:{src:v(363),alt:"Node Event Loop"}})]),e._v(" "),s("h3",{attrs:{id:"timers-阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#timers-阶段"}},[e._v("#")]),e._v(" timers 阶段")]),e._v(" "),s("p",[e._v("timers 阶段会执行 setTimeout 和 setInterval 回调，并且是由 poll 阶段控制的。 同样，在 Node 中定时器指定的时间也不是准确时间，只能是尽快执行。")]),e._v(" "),s("h3",{attrs:{id:"poll-阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#poll-阶段"}},[e._v("#")]),e._v(" poll 阶段")]),e._v(" "),s("p",[e._v("主要作用：")]),e._v(" "),s("ol",[s("li",[e._v("进入该阶段时设定了 timer 的话，判断poll 队列是否为空，如果是空的并且 timer 超时，回到 timer 阶段执行回调。")]),e._v(" "),s("li",[e._v("如果没有设定了 timer 的话，\n"),s("ol",[s("li",[e._v("如果 poll 队列不为空，会遍历回调队列并同步执行，直到队列为空或者达到系统限制")]),e._v(" "),s("li",[e._v("如果 poll 队列为空时，如果有 setImmediate 回调需要执行，poll 阶段会停止并且进入到 check 阶段执行回调，如果没有 setImmediate 回调需要执行，会等待回调被加入到队列中并立即执行回调，这里同样会有个超时时间设置防止一直等待下去")])])])]),e._v(" "),s("h3",{attrs:{id:"check-阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#check-阶段"}},[e._v("#")]),e._v(" check 阶段")]),e._v(" "),s("p",[e._v("setImmediate()的回调会被加入check队列中")]),e._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[e._v("宏任务和微任务区分")]),e._v(" "),s("ul",[s("li",[e._v("常见的 宏任务有setTimeout、setInterval、 setImmediate、script（整体代码）、 I/O 操作等。")]),e._v(" "),s("li",[e._v("new Promise().then(回调)等。")]),e._v(" "),s("li",[e._v("process.nextTick 是独立于 Event Loop 之外的，它有一个自己的队列，当每个阶段完成后，如果存在 nextTick 队列，就会清空队列中的所有回调函数，并且优先于其他 microtask 执行。")])])]),e._v(" "),s("h3",{attrs:{id:"与浏览器-event-loop-区别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#与浏览器-event-loop-区别"}},[e._v("#")]),e._v(" 与浏览器 Event Loop 区别")]),e._v(" "),s("p",[e._v("浏览器环境下，microtask的任务队列是每个macrotask执行完之后执行。而在Node.js("),s("strong",[e._v("node11 之前")]),e._v(")中，microtask会在事件循环的各个阶段之间执行，也就是一个阶段执行完毕，就会去执行microtask队列的任务。Node 11 之后行为与浏览器 Event Loop 保持一致。")]),e._v(" "),s("h2",{attrs:{id:"参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[e._v("#")]),e._v(" 参考资料")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://time.geekbang.org/column/article/132931",target:"_blank",rel:"noopener noreferrer"}},[e._v("浏览器工作原理与实践"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://juejin.im/post/6844904165462769678",target:"_blank",rel:"noopener noreferrer"}},[e._v("【掘金】深入解析你不知道的 EventLoop 和浏览器渲染、帧动画、空闲回调"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=a.exports}}]);